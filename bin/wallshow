#!/usr/bin/env bash
# wallshow - Professional Wallpaper Manager for Wayland/X11
# Author: UtsavBalar1231 <utsavbalar1231@gmail.com>
# Version: 1.0.0
# License: MIT
# Requires: bash 5.0+, jq, flock

# ============================================================================
# SCRIPT PATH & LIBRARY LOCATION DETECTION
# ============================================================================

# Script path
SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
declare -r SCRIPT_PATH

# Detect library location (dev vs system install)
WALLSHOW_LIB="${WALLSHOW_LIB:-}"
if [[ -z "${WALLSHOW_LIB}" ]]; then
	if [[ -d "$(dirname "$0")/../lib/core" ]]; then
		# Development mode
		WALLSHOW_LIB="$(cd "$(dirname "$0")/../lib" && pwd)"
	else
		# System install
		WALLSHOW_LIB="/usr/lib/wallshow"
	fi
fi

# ============================================================================
# SOURCE MODULES IN DEPENDENCY ORDER
# ============================================================================

# Helper to source with error checking
_source_module() {
	local module="$1"
	if [[ ! -f "${module}" ]]; then
		echo "ERROR: Module not found: ${module}" >&2
		exit 1
	fi
	# shellcheck source=/dev/null
	source "${module}" || {
		echo "ERROR: Failed to load module: ${module}" >&2
		exit 1
	}
}

# Core modules
_source_module "${WALLSHOW_LIB}/core/constants.sh"
_source_module "${WALLSHOW_LIB}/core/logging.sh"
_source_module "${WALLSHOW_LIB}/core/cache.sh"
_source_module "${WALLSHOW_LIB}/core/state.sh"
_source_module "${WALLSHOW_LIB}/core/config.sh"

# System modules (depend on core)
_source_module "${WALLSHOW_LIB}/system/paths.sh"
_source_module "${WALLSHOW_LIB}/system/locking.sh"
_source_module "${WALLSHOW_LIB}/system/init.sh"

# Wallpaper modules (depend on system)
_source_module "${WALLSHOW_LIB}/wallpaper/discovery.sh"
_source_module "${WALLSHOW_LIB}/wallpaper/selection.sh"
_source_module "${WALLSHOW_LIB}/wallpaper/backends.sh"
_source_module "${WALLSHOW_LIB}/wallpaper/session.sh"

# Animation modules (depend on wallpaper)
_source_module "${WALLSHOW_LIB}/animation/gif.sh"
_source_module "${WALLSHOW_LIB}/animation/playback.sh"

# Daemon modules (depend on animation)
_source_module "${WALLSHOW_LIB}/daemon/process.sh"
_source_module "${WALLSHOW_LIB}/daemon/ipc.sh"
_source_module "${WALLSHOW_LIB}/daemon/loop.sh"

# CLI modules (depend on daemon)
_source_module "${WALLSHOW_LIB}/cli/interface.sh"
_source_module "${WALLSHOW_LIB}/cli/commands.sh"

# ============================================================================
# MAIN ENTRY POINT
# ============================================================================

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
	main "$@"
fi
