name: Build Packages

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  build-debian:
    name: Build Debian Package
    runs-on: ubuntu-latest
    container:
      image: debian:bookworm
    steps:
      - name: Install build dependencies
        run: |
          apt-get update
          apt-get install -y \
            debhelper \
            devscripts \
            build-essential \
            bash \
            jq \
            socat \
            git

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build Debian package
        run: |
          dpkg-buildpackage -us -uc -b

      - name: Move generated packages to workspace
        run: |
          mv ../*.deb ./
          ls -lh *.deb

      - name: Upload Debian package
        uses: actions/upload-artifact@v4
        with:
          name: debian-package
          path: "*.deb"
          retention-days: 30

  build-arch:
    name: Build Arch Package
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - name: Install build dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm \
            base-devel \
            bash \
            jq \
            socat \
            git

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create source tarball for Arch build
        run: |
          version=1.0.0
          mkdir -p pkg/src
          tar czf pkg/wallshow-${version}.tar.gz \
            --transform "s,^,wallshow-${version}/," \
            bin lib logrotate.d systemd LICENSE README.md CONTRIBUTING.md
          mv pkg/wallshow-${version}.tar.gz pkg/src/

      - name: Create build user (makepkg can't run as root)
        run: |
          useradd -m builder
          chown -R builder:builder .
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

      - name: Build Arch package
        run: |
          cd pkg
          su builder -c "makepkg -sf --noconfirm"
          ls -lh *.pkg.tar.zst

      - name: Upload Arch package
        uses: actions/upload-artifact@v4
        with:
          name: arch-package
          path: pkg/*.pkg.tar.zst
          retention-days: 30

  build-rpm:
    name: Build RPM Package
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    steps:
      - name: Install build dependencies
        run: |
          dnf install -y \
            rpm-build \
            rpmdevtools \
            bash \
            jq \
            socat \
            git

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup RPM build environment
        run: |
          rpmdev-setuptree

      - name: Create source tarball
        run: |
          version=$(grep '^Version:' rpm/wallshow.spec | awk '{print $2}')
          mkdir -p wallshow-${version}
          cp -r bin lib logrotate.d systemd LICENSE README.md CONTRIBUTING.md wallshow-${version}/
          tar czf ~/rpmbuild/SOURCES/wallshow-${version}.tar.gz wallshow-${version}

      - name: Build RPM package
        run: |
          rpmbuild -ba rpm/wallshow.spec
          ls -lh ~/rpmbuild/RPMS/noarch/

      - name: Upload RPM package
        uses: actions/upload-artifact@v4
        with:
          name: rpm-package
          path: ~/rpmbuild/RPMS/noarch/*.rpm
          retention-days: 30

  test-install:
    name: Test Package Installation
    needs: [build-debian]
    runs-on: ubuntu-latest
    steps:
      - name: Download Debian package
        uses: actions/download-artifact@v4
        with:
          name: debian-package

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq socat

      - name: Install wallshow package
        run: |
          sudo dpkg -i *.deb || true
          sudo apt-get install -f -y

      - name: Test wallshow binary
        run: |
          wallshow --help
          wallshow --version || true

      - name: Verify file installation
        run: |
          test -f /usr/bin/wallshow
          test -d /usr/lib/wallshow
          test -f /etc/logrotate.d/wallshow
          test -f /usr/lib/systemd/user/wallshow.service
          echo "All files installed correctly"
