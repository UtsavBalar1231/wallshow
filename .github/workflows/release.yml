name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build-debian:
    name: Build Debian Package
    runs-on: ubuntu-latest
    container:
      image: debian:bookworm
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Install build dependencies
        run: |
          apt-get update
          apt-get install -y \
            debhelper \
            devscripts \
            build-essential \
            bash \
            jq \
            socat \
            git \
            nodejs

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Build Debian package
        run: dpkg-buildpackage -us -uc -b

      - name: Move package to workspace
        run: mv ../*.deb ./

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: debian-package
          path: "*.deb"

  build-arch:
    name: Build Arch Package
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    steps:
      - name: Install build dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm \
            base-devel \
            bash \
            jq \
            socat \
            git \
            nodejs

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare local source
        run: |
          version=$(grep '^pkgver=' pkg/PKGBUILD | cut -d'=' -f2)
          tar czf "pkg/wallshow-${version}.tar.gz" \
            --transform "s,^,wallshow-${version}/," \
            bin lib logrotate.d systemd LICENSE README.md CONTRIBUTING.md
          sed -i "s|^source=.*|source=(\"wallshow-\${pkgver}.tar.gz\")|" pkg/PKGBUILD
          sed -i "s|^sha256sums=.*|sha256sums=('SKIP')|" pkg/PKGBUILD

      - name: Create build user
        run: |
          useradd -m builder
          chown -R builder:builder .
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

      - name: Build Arch package
        run: |
          cd pkg
          su builder -c "makepkg -sf --noconfirm"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: arch-package
          path: pkg/*.pkg.tar.zst

  build-rpm:
    name: Build RPM Package
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    steps:
      - name: Install build dependencies
        run: |
          dnf install -y \
            rpm-build \
            rpmdevtools \
            bash \
            jq \
            socat \
            git \
            nodejs

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup and build RPM
        run: |
          rpmdev-setuptree
          version=$(grep '^Version:' rpm/wallshow.spec | awk '{print $2}')
          mkdir -p wallshow-${version}
          cp -r bin lib logrotate.d systemd LICENSE README.md CONTRIBUTING.md wallshow-${version}/
          tar czf ~/rpmbuild/SOURCES/wallshow-${version}.tar.gz wallshow-${version}
          rpmbuild -ba rpm/wallshow.spec

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rpm-package
          path: ~/rpmbuild/RPMS/noarch/*.rpm

  create-release:
    name: Create GitHub Release
    needs: [build-debian, build-arch, build-rpm]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: packages

      - name: Extract changelog
        run: |
          VERSION=${{ needs.build-debian.outputs.version }}
          if [ -f debian/changelog ]; then
            awk "/^wallshow \(${VERSION}/ {flag=1; next} /^wallshow \(/ {flag=0} flag" debian/changelog > release_notes.txt
          fi
          if [ ! -s release_notes.txt ]; then
            echo "Release ${VERSION}" > release_notes.txt
          fi

      - name: Create release with assets
        uses: softprops/action-gh-release@v2
        with:
          body_path: release_notes.txt
          files: |
            packages/debian-package/*.deb
            packages/arch-package/*.pkg.tar.zst
            packages/rpm-package/*.rpm
